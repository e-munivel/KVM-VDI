version: '3.7'
services:
  isard-apps-nextcloud-app:
    build:
      context: ${BUILD_ROOT_PATH}/docker/nextcloud
      dockerfile: Dockerfile
      args:
        - IMG=${NEXTCLOUD_IMG}
      #target: production
    container_name: isard-apps-nextcloud-app
    restart: unless-stopped
#    links:
#      - postgres
    depends_on:
      - isard-apps-postgresql
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${SRC_FOLDER}/nextcloud:/var/www/html
      - ${DATA_FOLDER}/nextcloud:/var/www/html/data
      #- ${BUILD_ROOT_PATH}/docker/nextcloud/custom_apps:/var/www/html/custom_apps
    environment:
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=${NEXTCLOUD_POSTGRES_USER}
      - POSTGRES_PASSWORD=${NEXTCLOUD_POSTGRES_PASSWORD}
      - POSTGRES_HOST=isard-apps-postgresql
      - REDIS_HOST=isard-apps-redis
      - NC_overwriteprotocol=https
      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.${DOMAIN}
    networks:
      - isard_net

  isard-apps-nextcloud-nginx:
    image: ${NGINX_IMG-nginx:1.21.6}
    container_name: isard-apps-nextcloud-nginx
    restart: unless-stopped
    links:
      - isard-apps-nextcloud-app
    volumes:
      - ${BUILD_ROOT_PATH}/docker/nextcloud/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${SRC_FOLDER}/nextcloud:/var/www/html:ro
    networks:
      - isard_net
